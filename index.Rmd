---
title: "ETC5521 Assignment 2"
subtitle: "How sustainable is the energy production in Europe? "
team: Koala
author:
  - Varsha Ujjinni VijayKumar
  - Justin Thomas
  - (Vinny Vu)
  - (Putu Saputra)
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: yes
bibliography: references.bib  
---

[This assignment is for ETC5521 Assignment 2 by Team `r rmarkdown::metadata$team` comprising of `r rmarkdown::metadata$author[1]` & `r rmarkdown::metadata$author[2]`.]{style="color:#006DAE;"}

![](https://media.giphy.com/media/3oxHQlREH7ufJK4yYg/giphy.gif)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r libraries, include = FALSE}
library(tidytuesdayR) 
library(tidyverse) 
library(knitr) 
library(ggplot2) 
library(kableExtra) 
library(bookdown) 
library(plotly) 
library(readr)
library(readxl)
library(naniar)
library(lubridate)
library(forcats)
library(scales)
```

```{css}
body{
  text-align: justify;
}

h1.title {
  text-align: center;
}

h3.subtitle {
  color: crimson;
  text-align: center;
}

h4.author {
  color: black;
  text-align: center;
}

h4.date {
  text-align: center;
}

```


# Introduction and motivation

In today's day and age there has been a strong push for the reduction in production and use of fossil fuels. Per Peninsula Energy, fossil fuels "produce a significant amount of greenhouse gas emissions, including carbon dioxide methane," (@peninsula_2018) These greenhouse gas emissions are known to be a main contributor to the ‘greenhouse effect’ “the warming of climate that results when the atmosphere traps heat radiating from Earth towards space,” (@twardy_greenhouse_2007). Not only does thermal power produced by fossil fuels emit greenhouse gases, it is not renewable, meaning it cannot be “replaced naturally in a short period of time”. This causes energy producers and companies to charge consumers based on demand, and as demand fluctuates, this results in long-term price volatility.

Per Our World Data, Europe is currently the 3rd highest consumer of primary energy behind Asia Pacific and North America making up approximately 15% of the total World Energy Consumption (@ritchie_energy_2014).  

As a result, the European power sector currently plays a crucial role in attaining targets to “cut green-house gases by 40% by 2030, compared to 1990” (@energiewende_european_2018) in favor of cleaner and more renewable energy sources. For the purposes of this analysis we will be using Eurostat European Energy data (Eurostat, 2020) to assess how successful they currently are and answer the questions:  


How sustainable is the energy production in Europe? 

Specifically:

1. Which countries have the highest production of sustainable energy based on energy types?
2. How do energy imports vs exports compare between countries in Europe from 2016-2018?
3. What are energy types that contribute to the total production of electricity for each country in Europe?


Additional Questions for Assignment 2 :

1. What is the difference in energy produced between hydro power and pumped hydro power?
2. How efficient is it produce electricity using pumped hydro power?
3. What has the trend been like for EU countries to achieve their 2020 renewable energy target?

We would like to address these new questions because we want to focus more on the original question, **"How sustainable is the energy production in Europe?"**. We think by picking out select renewable energy sources, like hydro power and pumped hydro power, it will help to give a more narrowed answer to the sustainability question. More specifically, it would be useful to see how the renewable energy sources we have selected compare across countries to visualize how these countries are trying to be more sustainable in their energy production.

The original analysis excluded Pumped Hydro power. Pumped hydro power is listed as a level 2 energy type in the data, whereas Hydro power is listed as a level 1 energy type. The data in the tidytuesday package points out that level 2 makes up level 1 that makes up the total (@mock_scherer_2020), meaning energy produced by Pumped Hydro power is included in Hydro power's energy production, which is the total energy production for both. However, there is clearly a difference between both these energy sources and we think it'll be interesting to look into these differences.

We also think it is interesting to look at how countries have been performing to reach their 2020 renewable energy target because it gives an overview into which country is taking a more proactive approach to becoming more sustainable. Thus, we are curious to see how countries have fared as of 2018 to see whether they are on track to reach their goal.

We are broadening the scope of the original analysis by addressing question 2. It is not adequate enough to say a country is adopting a more sustainable approach in their energy production if they way they produce that energy is inefficient. Therefore, we want to address efficiency in our analysis as well. In particular, we have found data that validates the fact that some countries use up more energy than produce energy when using pumped hydro power as an energy source. Our analysis will look deeper into this.

# Data description

```{r, include = FALSE}
energy_types <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-08-04/energy_types.csv')
country_totals <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-08-04/country_totals.csv')

energy_types <- energy_types %>%
  replace_na(list(country_name = "United Kingdom")) %>%
    pivot_longer(cols = starts_with("20"),
               names_to = "year",
               values_to = "energy")
energy_types$year <- as.numeric(energy_types$year)

country_totals <- country_totals %>% 
  replace_na(list(country_name = "United Kingdom")) %>%
  pivot_longer(cols = starts_with("20"),
               names_to = "year",
               values_to = "energy")
country_totals$year <- as.numeric(country_totals$year)
```

The data in the tidytuesday package is taken from Eurostat that contains the electricity production of the countries in the European Union.  The data is given in tabular form in two tables, `country_totals` and `energy_types`. The `energy_types` table containing the types of energy produced by each country. The `country_totals` table contains the break down of energy supplied by each country.

The variables in the `energy_types` table are included below in Table \@ref(tab:energy-tab-vr):

```{r,include = FALSE}
variables_1 <- energy_types %>% names()
class_1 <- sapply(energy_types, class)
desc_1 <- c("Country ID",
           "Country name",
           "Type of energy production",
           "Level - either total, level 1 or level 2. Where level 2 makes up level 1 that makes up the total",
           "Year of observation",
           "Total Energy in GWh (Gigawatt hours)")
```

```{r energy-tab-vr, echo=FALSE}
tibble(variables_1,class_1,desc_1) %>%
  kable(col.names = c("Variable","Class","Description"), caption ="Energy types variables") %>%
  kable_styling(bootstrap_options = "hover")
```

The variables in the `country_totals` table are included below in Table \@ref(tab:country-tab-vr): 

```{r, include = FALSE}
variables_2 <- country_totals %>% names()
class_2 <- sapply(country_totals, class)
desc_2 <- c("Country ID",
           "Country name",
           "Type of energy production",
           "Level - either total, level 1 or level 2. Where level 2 makes up level 1 that makes up the total",
           "Year of observation",
           "Energy in GWh (Gigawatt hours)")
```

```{r country-tab-vr, echo=FALSE}
tibble(variables_2,class_2,desc_2) %>%
  kable(col.names = c("Variable","Class","Description"), caption ="Country total variables") %>%
  kable_styling(bootstrap_options = "hover")
```

The data in the tidytuesday package only contains yearly totals from 2016-2018, (@tidytuesday). However, monthly data can be found on the Eurostat website including data from 2010 until May 2020 as at 14-08-20. The statistics are collected and compiled by Member States. Eurostat prepared a template to gather this information, (@methodology_eurostat).

```{r target-energy, eval=FALSE}
target_energy <- read_tsv("data/t2020_31.tsv")
write.csv(target_energy, 'target_energy.csv')
target_energy <- read_csv("data/target_energy.csv")
```

```{r, eval=FALSE}
target_energy <- target_energy[c(-12,-13,-14), 2:18]
target_energy <- as_tibble(target_energy) 
```

```{r tidying-data, include=FALSE}
euro_table <- read_xls("data/euro_table.xls") #reading in data
euro_table <- euro_table %>% rename(Country = `Share of renewable energy in gross final energy consumption`,
                      `2004` = ...2,
                      `2005` = ...3,
                      `2006` = ...4,
                      `2007` = ...5,
                      `2008` = ...6,
                      `2009` = ...7,
                      `2010` = ...8,
                      `2011` = ...9,
                      `2012` = ...10,
                      `2013` = ...11,
                      `2014` = ...12,
                      `2015` = ...13,
                      `2016` = ...14,
                      `2017` = ...15,
                      `2018` = ...16,
                      `2020` = ...17) #renaming the columns to appropriate names
euro_table <- euro_table[c((-1:-5),(-43:-50)),] #removing unnecessary rows and columns from the dataset
euro_table[37,1] <- "Kosovo" #changing the name of Kosovo from its long form to a short form
euro_table <- euro_table[-31,] #excluding Switzerland because there are no values
euro_table$`2004` <- as.numeric(euro_table$`2004`) #changing all the year columns to numeric data type
euro_table$`2005` <- as.numeric(euro_table$`2005`)
euro_table$`2006` <- as.numeric(euro_table$`2006`)
euro_table$`2007` <- as.numeric(euro_table$`2007`)
euro_table$`2008` <- as.numeric(euro_table$`2008`)
euro_table$`2009` <- as.numeric(euro_table$`2009`)
euro_table$`2010` <- as.numeric(euro_table$`2010`)
euro_table$`2011` <- as.numeric(euro_table$`2011`)
euro_table$`2012` <- as.numeric(euro_table$`2012`)
euro_table$`2013` <- as.numeric(euro_table$`2013`)
euro_table$`2014` <- as.numeric(euro_table$`2014`)
euro_table$`2015` <- as.numeric(euro_table$`2015`)
euro_table$`2016` <- as.numeric(euro_table$`2016`)
euro_table$`2017` <- as.numeric(euro_table$`2017`)
euro_table$`2018` <- as.numeric(euro_table$`2018`)
euro_table$`2020` <- as.numeric(euro_table$`2020`)
```

```{r target-longer, include=FALSE}
euro_table <- euro_table %>% pivot_longer(cols = `2004`:`2020`, names_to = "Year", values_to = "Percentage") # changing the dataset from a wide format to long format by taking all the Year columns and putting them into a single "Year" column and all their respective values into a "Percentage" column
euro_table$Year <- as.Date(as.character(euro_table$Year), format = "%Y") #changing the "Year" column data type to date
euro_table$Year <- year(euro_table$Year) #Taking only the year of the date
```

To answer how the trend has been for EU countries to reach their 2020 target, we needed further data. Thus we obtained an external dataset from the Eurostat website which provides information on each European country's renewable energy % share of the final energy consumption. The data is in a tabular format and provides the % share values from 2009-2018 and a target column which represents the country's 2020 target value, (@eurostat_2018). The source of this data is accredited to the European Environment Agency (EEA).

The variables in the `euro_table` table are included below in Table \@ref(tab:euro-tab-vr): 

```{r, include = FALSE}
variables_3 <- euro_table %>% names()
class_3 <- sapply(euro_table, class)
desc_3 <- c("Country name",
            "Year of observation",
           "Share of renewable energy (%)")
```

```{r euro-tab-vr, echo=FALSE}
tibble(variables_3,class_3,desc_3) %>%
  kable(col.names = c("Variable","Class","Description"), caption ="European table variables") %>%
  kable_styling(bootstrap_options = "hover")
```

## Missing values

```{r check-missing,message=FALSE,warning=FALSE,fig.cap="Missing values in table country_totals"}
library(naniar)
#vis_miss finds the missing values in the dataset and produces a plot for depicting the % of NA's in the dataset
#m1 <- vis_miss(energy_types) 
m2 <- vis_miss(country_totals) 
m2
```

Let's have a look at whether the datasets have any missing value, we check it using vis_miss() function from the naniar package as depicted in figure \@ref(fig:check-missing) we checked for both the dataframes and noticed that the dataframe energy_types has no missing values and the dataframe country_totals has a missing values of ~ 0.18% in the energy column within it.

## Limitations of Dataset

Some of the limitations to the `euro_table` dataset that might affect possible analysis are:

- There is no information on the renewable % share of final energy consumption for 2019. This will affect our analysis as there will be a gap between 2018 and the target year 2020, to see how the country has been performing. Without this information, it will be hard to transparently judge if a country is truly on track to reach it's 2020 target.
- There is no 2020 target information for some countries. This hampers our analysis as we cannot fairly judge if a country is meeting its sustainable target and contributing to overall sustainability in Europe.

# Analysis and findings

##  Which countries have the highest production of sustainable energy based on energy types? 

To assess which countries lead in renewable energy production we have used the energy_types table to make a bar plot in Figure \@ref(fig:average-production-plotly).  The bar plot shows the average production of renewable energy in the positive y-axis and average conventional thermal energy on the negative y-axis. The average across the 3 years was used as the individual plots for 2016-2018 did not show much variation due to the relatively short period of time. From the plot we can see France, Germany, Spain, Norway and Sweden lead Europe in the production of renewable energy, with France producing almost an average 500,000 GWh a year with Nuclear making up the majority of the renewable energy production. France also has a significantly small level of conventional thermal energy production compared to renewable energy. Although Germany is second leading producer of renewable energy, they are also the leading European producer of conventional thermal energy producing almost 363,000 GWh of energy per year.   


```{r average_production_plot }
options(scipen = 999)
average_production <- energy_types %>%
  filter(type != "Pumped hydro power") %>% # filtering out pumped hydro power which is already included as hydro power 
  group_by(country_name,type) %>%
  summarise(average_energy = mean(energy)) %>% # calculating the mean energy production across the 3 years 
  pivot_wider(id_cols = country_name,
              names_from = type,
              values_from = average_energy) %>% # making the energy types into separate columns to allow manipulation of variables
  mutate(Total_Renewable = Nuclear + Hydro + Wind + Solar + Geothermal + Other) %>% # calculating the total renewable energy production 
  mutate(`Conventional thermal` = -`Conventional thermal`) %>% # making conventional thermal energy into a negative value 
  pivot_longer(cols = -c(country_name,Total_Renewable),
               names_to = "Energy Type",
               values_to = "Value")  #converting the tibble back into long form to allow plotting 
#average_production$value <- format(average_production$value,scientific = FALSE)
average_production_plot <- ggplot(average_production, aes(x = Value, 
                                                          # reordering the country names by total renewable energy production 
             y = reorder(country_name,-Total_Renewable), 
            #y=country_name,
             fill = `Energy Type`)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90)) + #rotating x axis to values do not overlap 
  xlab("Energy in GWh(Gigawatt hours)") +
  ylab("") +
  ggtitle("Average energy production by type from 2016-2018") 
       
```

```{r average-production-plotly, fig.cap= "Average Renewable vs Non-Renewable Energy Production from 2016-2018" }
ggplotly(average_production_plot)
  #style(text = paste0(signif(average_production$value, digits = 6), "\n", average_production$country_name, "\n", average_production$`Energy Type`), traces = 1:37) 
```


```{r yearly_production_plot}
yearly_production_plot <- energy_types %>%
  filter(level != "Level 2") %>% # filtering out pumped hydro power which is already included as hydro power 
  group_by(type,year) %>%
  summarise(total = sum(energy)) %>% # calculating total energy production 
  pivot_wider(id_cols = year,
              names_from = type,
              values_from = total) %>% # making energy types into columns to allow manipulation of values 
  mutate(`Total Renewable` = Geothermal + Hydro + Nuclear + Other + Solar + Wind) %>% # calculating total renewable energy 
  pivot_longer(cols = -year,
               names_to = "Type",
               values_to = "Total") %>% # converting back to long form to allow plotting 
  ggplot(aes(x = reorder(Type,-Total),
             y = Total,
             fill = Type)) +
  geom_col() +
  facet_wrap(~year) +
  theme(axis.text.x = element_text(angle = 90), #rotating the x axis to prevent values overlapping 
        axis.title.y = element_text(vjust=1),
        legend.position = "none") + #moving the y axis labels to prevent the text overlapping the y axis values 
  labs(title = "Total Energy Production by Type and Year",
       x = "",
       y = "")

```

To look closer at European energy production across the 3 years the plot in \@ref(fig:yearly-production-plotly) shows the breakdown of the total production of each energy type for each year. For comparability between total renewable and non-renewable energy production a total renewable column is added. From the graph we can see the production of renewable energy exceeds the production thermal energy across all years. Notably nuclear energy leads the production of renewable energy with France being a leading producer. Conventional thermal energy still however contributes to just under 50% of energy production. From \@ref(fig:average-production-plotly), although there are several countries with renewable energy greatly exceeding fossil fuels several countries such as Germany, United Kingdom, Italy and Turkey show high levels of conventional thermal energy production.   


```{r yearly-production-plotly, fig.cap= "Total Energy Production by Type and Year"}
y <- list(title = "Total energy production in GWh (Gigawatt hours)", titlefont = list(size=14), automargin = TRUE) 

ggplotly(yearly_production_plot, tooltip = "y") %>% #outputting yearly_production_plot as a plotly 
  layout(yaxis = y)
```


## How do energy imports vs exports compare between countries in Europe from 2016-2018?

Per Our World Data Europe only makes up 15% of the total World Energy Consumption (@ritchie_energy_2014). Therefore, to assess the global impact of Europe's renewable energy production we are interested in assessing the energy imports and exports of each country. Using the country_totals we have created the plot in Figure \@ref(fig:export-import-plot) showing the average exports on the positive y-axis and imports on the negative y-axis for each country across 2016-2018. Further points were added to visualize the net export less imports with the size of the point representing the total net production. We have decided to use the average across 2016-2018 as there is not a significant change in energy exports and imports across the 3 years.

From the visualization we can see Germany, France, Sweden, Norway and Czechia are the leading 5 countries in net exports less imports. Furthermore from the first visualization Figure \@ref(fig:average-production-plotly) these countries lead Europe in the production of renewable energy with Germany and France being Europe's largest total net producer of energy showing signs of not only the production of renewable energy for local use but net exportation of renewable energy also. Further, from the visualization we can see Italy, Finland, United, Kingdom, Hungry and Belgium lead in net imports (imports greater than exports) in Europe.



```{r export-import-plot, fig.cap= "Average Export and Imports by Country 2016-2018"}
export_import_plot <- country_totals %>%
  replace_na(list(energy = 0)) %>% #replacing NA values with 0 
  group_by(country_name,type) %>%
  summarise(average = mean(energy)) %>% # calculating the average production levels for each year 
  pivot_wider(id_cols = country_name,
              names_from = type,
              values_from = average) %>% # converting to wide form to allow manipulation of variables 
  mutate(Imports = -Imports) %>% # making imports a negative value to allow plotting 
  select(country_name,Exports,Imports,`Total net production`) %>% # selecting relevant variables for plotting 
  mutate(net_import_export = Exports + Imports) %>% # calculating net export-imports 
  pivot_longer(cols = -c(country_name,`Total net production`, net_import_export), # converting back to long form the allow plotting 
               names_to = "Type",
               values_to = "Energy") %>%
  ggplot(aes(y = reorder(country_name,-net_import_export))) + #reordering the countries by net export-imports to allow comparability 
  geom_col(aes(x = Energy,
               fill = Type)) +
  geom_point(aes(x = net_import_export, #adding a point for the next export import
                 size = `Total net production`)) + #changing the size of points to represent the total net production 
  theme(axis.text.y = element_text(angle = 360)) + # rotating the x axis text to prevent text to overlap 
  labs(x = "",
       y = "Energy in GWh (Gigawatt hours)",
       title = "Average Export and Imports by Country 2016-2018") 

export_import_plot
```



To look at Europe's net export-imports as a whole Table \@ref(tab:net-export-kable) shows summary of the total energy production levels across each year. From the table in 2016 and 2017 Europe is at a net export but in 2018 they are at a net import. This drop in 2018 is due to the spike in imports and drop in export in 2018. It should be noted there is a drop in total net production in 2018 suggesting reduced energy consumption supporting reduction of consumption of fossil fuels.    



```{r net-export-kable, fig.cap= "European Energy Production Summary 2016-2018"}
country_totals %>%
  replace_na(list(energy = 0)) %>% # replacing NA values with o 
  group_by(type,year) %>%
  summarise(total = sum(energy)) %>% # calculating the total energy production 
  pivot_wider(id_cols = year,
              names_from = type,
              values_from = total) %>% # making energy types into columns
  mutate(`Net export-imports` = Exports - Imports) %>% # calculating net exports-imports 
  select(year, `Total net production`, `Energy supplied`, `Energy absorbed by pumping`, Exports, Imports, `Net export-imports`) %>% #reordering the columns 
  kable(caption = "European Energy Production Summary 2016-2018") %>%
  kable_styling()
```
  
## Energy types contribution to total energy production for each country in Europe

```{r contribution-tbl-country, include=FALSE, warning=FALSE, message=FALSE}
extract_total_net <- function(x){
total_year <- country_totals %>% 
  filter(type=="Total net production", year==x) %>%
  select(-type,-country) %>%
  pivot_wider(names_from = "level", values_from ="energy")
return(total_year)
}

country_total_2016 <- extract_total_net(2016)
country_total_2017 <- extract_total_net(2017)
country_total_2018 <- extract_total_net(2018)

extract_energy <- function(x){
total_year <- energy_types %>% 
  filter(year==x, level == "Level 1") %>%
  select(-country) %>%
  pivot_wider(names_from = "type", values_from ="energy")
return(total_year)
}

en_types_2016 <- extract_energy(2016)
en_types_2017 <- extract_energy(2017)
en_types_2018 <- extract_energy(2018)
```

```{r, country-in-3y, include=FALSE}
country_total_3y <- country_total_2016 %>%
                      left_join(country_total_2017, by=c("country_name")) %>%
                      left_join(country_total_2018, by=c("country_name")) %>%
                    mutate(Total_3y = Total.x+Total.y+Total) %>%
                    select(country_name,Total_3y)

en_types_3y <- en_types_2016 %>%
                      left_join(en_types_2017, by=c("country_name")) %>%
                      left_join(en_types_2018, by=c("country_name")) %>%
                    mutate(Thermal_3y= `Conventional thermal.x`+`Conventional thermal.y` + `Conventional thermal`,
                           Nuclear_3y = Nuclear.x + Nuclear.y + Nuclear,
                           Hydro_3y = Hydro + Hydro.x+ Hydro.y,
                           Wind_3y = Wind.x + Wind.y + Wind,
                           Solar_3y = Solar.x + Solar.y + Solar,
                           Geothermal_3y = Geothermal.x + Geothermal.y + Geothermal,
                           Other_3y = Other.x+Other.y+Other) %>%
                    select(country_name, Thermal_3y,Nuclear_3y, Hydro_3y, Wind_3y, Solar_3y, Geothermal_3y, Other_3y)


en_contribution_3y <- en_types_3y %>%
  inner_join(country_total_3y, by="country_name") %>%
  mutate(thermal = round(Thermal_3y/Total_3y*100, digits = 2),
         nuclear = round(Nuclear_3y/Total_3y*100, digits = 2),
         hydro = round(Hydro_3y/Total_3y*100, digits = 2),
         wind = round(Wind_3y/Total_3y*100, digits = 2),
         solar = round(Solar_3y/Total_3y*100, digits = 2),
         geothermal = round(Geothermal_3y/Total_3y*100, digits = 2),
         other = round(Other_3y/Total_3y*100, digits = 2)) %>%
    select(-c(Thermal_3y, Nuclear_3y, Hydro_3y, Wind_3y, Solar_3y, Geothermal_3y,Other_3y, Total_3y)) 
```


```{r tbl-contribution-europe, include=FALSE, warning=FALSE, message=FALSE}
get_total <- function(df1,df2,df3){
  df1 <- df1 %>%
  summarise(year=min(year), Total = sum(Total))
  df2 <- df2 %>%
  summarise(year=min(year), Total = sum(Total))
  df3 <- df3 %>%
  summarise(year=min(year),Total = sum(Total))
 rbind(df1,df2,df3) 
}

europe_total_production <- get_total(country_total_2016,country_total_2017,country_total_2018)

europe_energy_cont <- function(df){
  df %>%
  summarise(year = min(year),
            Geothermal = sum(Geothermal),
            Nuclear = sum(Nuclear),
            Hydro = sum(Hydro),
            Wind = sum(Wind),
            Solar = sum(Solar),
            `Conventional thermal` = sum(`Conventional thermal`),
            Other = sum(Other))
}

europe_total_energy <- rbind(europe_energy_cont(en_types_2016),
                           europe_energy_cont(en_types_2017),
                           europe_energy_cont(en_types_2018))

europe_energy_contribution <- function(df1,df2){
df1 %>%
  left_join(df2, by="year") %>%
  mutate(Thermal = round(`Conventional thermal`/Total*100, digits = 2),
         Nuclear = round(Nuclear/Total*100, digits = 2),
         Hydro = round(Hydro/Total*100, digits = 2),
         Wind = round(Wind/Total*100, digits = 2),
         Solar = round(Solar/Total*100, digits = 2),
         Geothermal = round(Geothermal/Total*100, digits = 2),
         Other = round(Other/Total*100, digits = 2)) %>%
    select(-c(`Conventional thermal`, Total)) 
}

contribute_to_europe <- europe_energy_contribution(europe_total_energy,
                                                   europe_total_production)
```

To get the energy proportion, the method we used is to divide the total energy by type by the total energy production. The results obtained are in the form of a percentage. Figure \@ref(fig:chart-europe) shows the percentage of the contribution of energy types to the total electricity production in Europe for 2016, 2017 and 2018. From the data shown on the graph, in general, there are differences in the contribution of each energy type. Thermal energy is still the highest energy supply comprising of nearly 50% of total European production. Nuclear energy outperforms three renewable energy sources, Hydro, Wind, and Solar by more than 20%. Geothermal and other energy sources are the only energy sources with the lowest contribution by not reaching 1%.

```{r chart-europe, fig.cap="The proportion of each energy type to the total energy production in Europe"}
p <- contribute_to_europe %>%
    pivot_longer(cols=c(2:8),
                 names_to = "contribution",
                 values_to = "value")

 a <- p %>%
   mutate(contribution_fct = fct_reorder(contribution,value)) %>%
  ggplot(aes(x=contribution_fct,
         y=value,
         fill=contribution)) +
  geom_bar(stat="identity",
           position = "dodge",
           width = 1) +
 #  geom_text(aes(label=value), position = "stack", hjust=-0.5, size=2.5) +
   facet_wrap(~year) +
   
  ggtitle("Energy source contribution to the total production in Europe")+
    ylab("percentage") +
    xlab("") +
   scale_y_continuous(limits = c(0,100))+
   coord_flip()+
   theme_minimal() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6),
        axis.text.y = element_text(size=7), 
        axis.title.y = element_text(size=6),
        axis.title.x = element_text(size=6),
        plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9, face = "bold"))

ggplotly(a, tooltip = c("fill","y"))
```

Now let us look at the presentation of the energy types for each country in Figure \@ref(fig:plot-contribution-country-3y). In general, the majority of countries in Europe rely on thermal energy as the leading supplier of energy needs for their country. However, it is interesting that Albania relies almost mostly on Hydro power. The same situation occurs in Norway and Georgia which rely on Hydro power to provide them more than 80% of their energy source. Meanwhile, the energy intake in France, Slovakia, and Hungary are dominated by nuclear power. France has 58 nuclear power reactors and is the highest country with almost 71% nuclear contribution for its country, (@iaea_country). While Slovakia and Hungary have more than 50% nuclear energy contribution. Denmark is the country with the most significant wind power utilization with nearly 48%, followed by Lithuania and Ireland at 32% and 25% respectively. As for solar energy, many have adopted it, but it is not that popular. The top 3 countries that utilize solar power are Italy, Greece and Germany where it produces about 8%, 7.7% and 6.85% respectively. Only Italy and Turkey use geothermal as an energy source producing around 2%.

```{r plot-contribution-country, fig.cap="The proportion of each energy type to the total energy production in each country"}
create_plot <- function(df){
df_tbl <-  df %>%
    pivot_longer(cols=c(2:8),
                 names_to = "contribution",
                 values_to = "value") 
#df_tbl$contribution = factor(df_tbl$contribution, #levels=c('thermal','nuclear','hydro','wind','solar','geothermal','other'))
  
df_tbl %>%
  mutate(country_fct = fct_reorder(country_name, value)) %>%
  ggplot(aes(x=country_fct, y= value, fill= contribution)) +
  geom_col(position = "stack") +
  theme_minimal() +
  #facet_wrap(contribution ~., ncol=7) +
  coord_flip() +
  ggtitle("Energy source contribution to the total production in 2016-2018")+
    ylab("percentage") +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.text.x = element_text(size = 6),
        axis.text.y = element_text(size=7),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=6),
        plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9, face = "bold"))
}
```

```{r plot-contribution-country-3y, fig.cap="The proportion of each energy type to the total energy production in each country in 3 years"}
ggplotly(create_plot(en_contribution_3y))
```

If we take a closer look at Malta, it's interesting to find that they are the only country to not have full 100% energy production. After checking the dataset, we found out that the total amount of net production does not equal to sum of energy types production in all observed years. As seen in Table \@ref(tab:tbl-malta), Malta did not list any energy type in 2018 except for Conventional Thermal. So there is an insufficient value when we calculate the contributions.

```{r tbl-malta}
malta <- rbind(country_total_2016,
      country_total_2017,
      country_total_2018) %>%
  filter(country_name=="Malta") %>%
  select(-year, -country_name)

malta_en <- rbind(en_types_2016,
      en_types_2017,
      en_types_2018) %>%
  filter(country_name=="Malta") %>%
  select(-level)

cbind(malta_en,malta) %>%
  kable(caption = "Energy type of Malta in 2016-2018") %>%
  kable_styling("hover")
```

## What is the difference in energy produced between Hydro power and Pumped Hydro power?

```{r cmp,message=FALSE,warning=FALSE,fig.cap="Difference in electricity produced by pumped hydro and hydro power"} 
# removing the level column for our analysis
prod <- energy_types %>% select(-level) %>% 
  #filtering the energy types to be hydro and pumped hydro for comparison
  dplyr::filter(type %in% c("Hydro" ,"Pumped hydro power"))

electricity_prod <- prod %>% 
  #converting the table above to wider format for computation
  pivot_wider(names_from = type, values_from = energy) %>%
  #grouping by country names and year for computation
  group_by(country_name,year) %>% rename(c("pumped_hydro_power" = "Pumped hydro power")) %>% 
  #calculating the difference between electricity produced by pumped hydro and hydro power and creating a new column called diff
  mutate(diff = (Hydro - pumped_hydro_power)) %>% 
  #arranging the  new column diff by descending order to remove the 0.00 values in the plot
  arrange(desc(diff)) %>% 
  #taking into account the first 40 values for plot
  head(40)

#plotting a bar graph with x-axis country names and y-axis as the difference value 
p1 <- ggplot(electricity_prod,aes(x = fct_reorder(country_name,-diff), y = diff, fill = year)) + 
  geom_col()+ 
  #setting the country names to display at a angle 90 for readability
  theme(axis.text.x = element_text(angle = 90),legend.position = "none") +
  #giving the scales a pretty accurate scales instead of a e-scales using the scales package
  scale_y_continuous(labels = number_format())+
  #changing the x-axis title/label to country names
  xlab("country names") + 
  #facet wrapping the plots by year
  facet_wrap(~ year) +
  #changing the plot having x-axis and y-axis interchanged so it is easier to read the country names
  coord_flip()

#adding ggplotly interaction to the above graph
diff_plotly <- ggplotly(p1)
  
#creating another dataframe with just the energy type hydro for comparison
hydro_pro <- energy_types %>% filter(type == "Hydro") %>% 
  #grouping by the country names and the year
  group_by(country_name,type,year) %>%
  #calculating the average values of hydro energy for every year within each country
  summarise(avg_energy = mean(energy)) %>% 
  #arranging the avg_energy by descending order to remove the 0.00 values in the plot
  arrange(desc(avg_energy)) %>% 
  head(50)

#plotting a bar graph for x-axis country names and y-axis with average energies 
p2 <- p2 <- ggplot(electricity_prod,aes(x = fct_reorder(country_name,-pumped_hydro_power), y = pumped_hydro_power, fill = year)) + 
  geom_col() +
  theme(axis.text.x = element_text(angle = 90),legend.position = "none") +
  xlab("country name") + 
  facet_wrap(~ year) +
  coord_flip()

hydro_plotly <- ggplotly(p2)

#arranging the two ggplotly plots into one plot using the subplot() from the plotly package
subplot(diff_plotly,hydro_plotly,margin = 0.10,titleX = TRUE,titleY = TRUE) %>% 
  #adding the titles and the axis labels to the subplot object
  layout(title = "Difference in electricity produced by pumped hydro & hydro power", 
         xaxis2 = list(title = "Electricity by hydro power"),
         xaxis5 = list(title = "Electricity by pumped hydro"),
         yaxis = list(title = "Country"),
         margin = list(l = 100, r = 20))
```


In figure \@ref(fig:cmp), we utilized a coding tip we learnt in lecture 4 to help us visualize the plot better. We used the "forcats::fct_reorder" function to reorder the way the countries are arranged. Our code displays the countries' value in a descending order. Thus countries with a lower difference value/ pumped hydro value will be displayed last. However, since we used the "coord_flip" function, we reversed the axes and now our graph appears to show countries with a lower difference value/ pumped hydro value at the top of the plot.

Looking at the metadata and dataset, we notice that the pumped hydro power and hydro power have been put together as electricity produced by hydro power. When researching into hydro power and pumped hydro power, it can be said that they are different ways of producing electricity using water as their source (@altenergymag).

Hence, we can find the amount of electricity produced by each of the techniques using a bar graph such as \@ref(fig:cmp). We notice that the electricity produced by hydro power is higher than that of pumped hydro power. For example, Norway clearly shows that there is a huge amount of difference in the electricity production where the energy produced by hydro power is **`r  hydro_pro %>% filter(country_name == "Norway" & year == 2016) %>% pull(avg_energy)` ** Gwh for year 2016,**`r  hydro_pro %>% filter(country_name == "Norway" & year == 2017) %>% pull(avg_energy)` ** Gwh for year 2017, **`r  hydro_pro %>% filter(country_name == "Norway" & year == 2018) %>% pull(avg_energy)`** Gwh for year 2018. Whereas, electricity produced by the same country through the pumped hydro power technique is **`r  electricity_prod %>% select(country_name,pumped_hydro_power) %>%  filter(country_name == "Norway" & year == 2016) %>% pull(pumped_hydro_power)`** Gwh for year 2016 , **`r  electricity_prod %>% select(country_name,pumped_hydro_power) %>%  filter(country_name == "Norway" & year == 2017) %>% pull(pumped_hydro_power)` ** Gwh for year 2017, **`r  electricity_prod %>% select(country_name,pumped_hydro_power) %>%  filter(country_name == "Norway" & year == 2018) %>% pull(pumped_hydro_power)`** Gwh for the year 2018.

Just like Norway, every other country has a very low amount of pumped hydro power produced compared to the hydro power. Some of the countries like Georgia and Serbia have very low counts of hydro power but even less or around 0 GWh amount of electricity produced by either of the two techniques meaning either they do not use pumped hydro power as one of their techniques or the data is not available for us.


## How efficient is it to produce electricity using Pumped Hydro power?

```{r pumped-power,message=FALSE,warning=FALSE,fig.cap= "Difference between electricity produced & absorbed by pumped hydro power",fig.width= 9}
hydro <- energy_types %>% 
  #filtering the pumped hydro power energy for a new dataframe 
  filter(type == "Pumped hydro power") %>% 
  #selecting columns other than country (codes) and level
  select(- c(country,level)) 

energy_tab <- energy_types %>%
  filter(type == "Pumped hydro power") %>%
  select(-level)
country_tab <- country_totals %>% 
  filter(type == "Energy absorbed by pumping") %>% 
  select(-level) %>% 
  rename(c(
    "energy_used" = "energy",
    "energy_type" = "type"
  )) 

pumped_abs <- country_tab %>% 
  #renaming column names within the dataframe country_tab for avoiding multiple columns of the same data 
  rename(c("year_country" = "year", "country_full" = "country_name")) %>% 
  #selecting only a few columns from the formed dataframe
  select(energy_type,year_country,energy_used,country_full)

#binding the two dataframes by columns cbind() function using the country names 
binded_hydro <- cbind(hydro,pumped_abs, by.x = "country_name", by.y = "country_full") %>% 
  #selecting columns other than year, country, by.x, by.y columns 
  select(- c(year_country,country_full,by.x,by.y)) %>% 
  #grouping by the country names and the year for computation
  group_by(country_name,year) %>%
  #mutating the dataframe for a difference values between the energy the pumped hydro power consumes and 
  #the energy the pumped hydro power produces and creating a new column Diff_prod
  mutate(Diff_prod = energy - energy_used) %>%  
  #arranging in descending the Diff_prod column 
  arrange(desc(Diff_prod)) %>% 
  #filtering the column Diff_prod to leave out country names with a diff value = 0.00
  filter(Diff_prod != 0.00)


#plotting the above binded dataframe on a bar graph 
prod_plot_16 <- ggplot(binded_hydro %>% filter(year == 2016),
       aes(x = reorder(country_name, - Diff_prod), 
           y = Diff_prod, fill = year)) + 
  geom_col() +
  # facet_wrap(~ year) + 
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none") +
  coord_flip()

#adding the plot into the ggplotly function for interaction 
p3 <-ggplotly(prod_plot_16)

prod_plot_17 <- ggplot(binded_hydro %>% filter(year == 2017),
       aes(x = reorder(country_name, - Diff_prod), 
           y = Diff_prod, fill = year)) + 
  geom_col() +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none") +
  coord_flip()

#adding the plot into the ggplotly function for interaction 
p4 <-ggplotly(prod_plot_17)

prod_plot_18 <- ggplot(binded_hydro %>% filter(year == 2018),
       aes(x = reorder(country_name, - Diff_prod), 
           y = Diff_prod, fill = year)) + 
  geom_col() +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none") +
  coord_flip()

#adding the plot into the ggplotly function for interaction 
p5 <- ggplotly(prod_plot_18)

#arranging the three ggplotly plots into one plot using the subplot() from the plotly package
subplot(p3,p4,p5,margin = 0.10,titleY = TRUE,titleX = TRUE ) %>% 
  #adding titles and the axis labels/titles for the subplot object
  layout(title = "Electricity produced v/s absorbed by pumped hydro power",
yaxis = list(title = "Country"),
yaxis2 = list(title = ""),
yaxis3 = list(title = ""),
xaxis = list(title = ""),
xaxis2 = list(title = "Difference in electricity produced and absorbed"),
xaxis3 = list(title = ""))
```

Now, we compared the two dataframes, energy_types and country_totals for the energy type "Pumped hydro power". There was something out of the ordinary in the country_totals table where the column type had a value *"energy absorbed for pumping"*, which really caught our attention. On further analyzing what this could be, we compared the amount of electricity produced by the pumped hydro power and the amount of energy consumed by the pumped hydro power to produce the same energy for different countries.

Figure \@ref(fig:pumped-power) shows a bar graph with countries on its y-axis and the difference in energy produced & absorbed within each of those countries across three years shown on the x-axis. **The years 2016 and 2017 have negative values which indicates that the energy absorbed by the pumped hydro power technique was higher than the energy it produced **. Although 2018 is also similar and holds true to the above statement, there are some countries which have improved its consumption:production ratio over the years. For instance, let's have a look at Austria which has showed a significant change through the years with a energy production of **`r binded_hydro %>% filter(country_name == "Austria" & year == 2016) %>% pull(Diff_prod)`** Gwh in year 2016 but in **`r binded_hydro %>% filter(country_name == "Austria" & year == 2018) %>% pull(Diff_prod)`** Gwh for the year 2018, it was one of the top countries for having a huge turn over in the consumption:production ratio. Countries like Germany had more consumption than production with **`r binded_hydro %>% filter(country_name == "Germany" & year == 2016) %>% pull(Diff_prod)`** Gwh in the year 2016 , although it had a slight decrease in the consumption of energy with **`r binded_hydro %>% filter(country_name == "Germany" & year == 2017) %>% pull(Diff_prod)`** in the year 2017, they are still working towards reduction of consumption:production ratio with **`r binded_hydro %>% filter(country_name == "Germany" & year == 2018) %>% pull(Diff_prod)`** in the year 2018 which is good. (minus values indicate that the consumption is higher than the production rate of energy)

There are still many countries which have incorporated pumped hydro power for production of energy but are still lagging in reducing the consumption to production ratio.

## What has the trend been like for EU countries to achieve their 2020 renewable energy target?

```{r target-plot,fig.cap="Percentage of renewable energy consumed from 2010 - 2018",fig.width=10,fig.height=8}
target <- #filtering only the years 2010-2018
ggplot(euro_table %>% filter(Year %in% c(2010,2011,2012,2013,2014,2015,2016,2017,2018)), aes(x=Year, y=Percentage, color=Country)) +
  geom_line() +
  geom_point(data = euro_table %>% filter(Year == 2020)) + #filtering only to show the target value (2020) as a dot point on the graph
  #annotate("text", x = 2020, y = 43, label = "2020 Target", colour = "red", size = 3) + #adding a text on the graph to clearly show the dot point is the "2020 Target"
  scale_y_continuous(breaks = c(0,10,20,30,40,50,60,70,80)) + #adding breaks to the y-axis
  scale_x_continuous(breaks = c(2010,2011,2012,2013,2014,2015,2016,2017,2018,2020)) + #adding breaks on the x-axis to show every year from 2010-2018
  theme(axis.text.x = element_text(angle = 90)) + #rotating the x-axis labels by 90 degrees
  ylab("Share of energy consumed that is renewable energy (%)") + #adding a y-axis label
  ggtitle("Percentage of renewable energy consumed from 2010 - 2018") + #adding a plot title
  theme(legend.position = "none",               # excluding the legend
        plot.title = element_text(hjust = 0.5), # centering the plot title
        plot.margin = unit(c(0.5,0.5,0.5,0.5),"lines"),
        #axis.title.y.left = element_text(margin = unit(c(0,0,0,1),"lines")),
        axis.title.x = element_text(margin = unit(c(3,3,5,3),"lines"))) + 
  facet_wrap(~Country, ncol = 9) #display a line graph for each country

ggplotly(target) 
```


Figure \@ref(fig:target-plot) shows the % share of renewable energy consumed from 2010-2018 for each country. Although it looks like all the countries have only seen a constant trend towards their respective 2020 renewable energy target, if we take a closer look by hovering over the line for each country, we find that it has been increasing ever so slightly. 

The dot point in 2020 represents the 2020 target for the respective country. Please take note that some countries do not have a target value as is mentioned in the limitations section. Also there is no value recorded for 2019 and so this does not appear on the graph. 

From the graph, countries like Iceland, Finland, Norway and Sweden have the highest share of renewable energy. Norway consumed *`r euro_table %>% filter(Country == "Norway" & Year == 2018) %>% select(Percentage)`%* of it's energy as renewable energy in 2018, followed by Iceland at *`r euro_table %>% filter(Country == "Iceland" & Year == 2018) %>% select(Percentage)`%*, Sweden at *`r euro_table %>% filter(Country == "Sweden" & Year == 2018) %>% select(Percentage)`%* and Finland at *`r euro_table %>% filter(Country == "Finland" & Year == 2018) %>% select(Percentage)`%*. Although Iceland and Norway don't have a 2020 target, they are well above their European counterparts and it is fair to say they have surpassed all renewable energy target level. Finland has surpassed their 2020 target level in 2014 and Sweden all the back in 2012!

Cyprus, Denmark, Germany and the United Kingdom have a trend that is most noticeable to see as countries with the share of renewable energy consistently increasing over the years. Cyprus has increased from *`r euro_table %>% filter(Country == "Cyprus" & Year == 2010) %>% select(Percentage)`%* in *`r euro_table %>% filter(Country == "Cyprus" & Year == 2018) %>% select(Percentage)`%* and have already surpassed their 2020 target level of *`r euro_table %>% filter(Country == "Cyprus" & Year == 2020) %>% select(Percentage)`%*! Denmark reported the largest increase over the 9 year period from *`r euro_table %>% filter(Country == "Denmark" & Year == 2010) %>% select(Percentage)`%* to *`r euro_table %>% filter(Country == "Denmark" & Year == 2018) %>% select(Percentage)`%* and reached their 2020 target of *`r euro_table %>% filter(Country == "Denmark" & Year == 2020) %>% select(Percentage)`%* way back in 2015! Germany has increased *`r euro_table %>% filter(Country == "Germany" & Year == 2010) %>% select(Percentage)`%* to *`r euro_table %>% filter(Country == "Germany" & Year == 2018) %>% select(Percentage)`%* and are on track to reach their 2020 target of *`r euro_table %>% filter(Country == "Germany" & Year == 2020) %>% select(Percentage)`%*. The United Kingdom has increased from *`r euro_table %>% filter(Country == "United Kingdom" & Year == 2010) %>% select(Percentage)`%* to *`r euro_table %>% filter(Country == "United Kingdom" & Year == 2018) %>% select(Percentage)`%* and are on track to reach their 2020 target of *`r euro_table %>% filter(Country == "United Kingdom" & Year == 2020) %>% select(Percentage)`%*.

Albania and Montenegro have been going down in the share of their renewable energy. Montenegro has reported a 5.2% reduction dropping from *`r euro_table %>% filter(Country == "Montenegro" & Year == 2014) %>% select(Percentage)`%* in 2014 to *`r euro_table %>% filter(Country == "Montenegro" & Year == 2018) %>% select(Percentage)`%* in 2018. Albania has seen an inconsistent trend and recently dropped to *`r euro_table %>% filter(Country == "Albania" & Year == 2018) %>% select(Percentage)`%* in 2018 from an all time high of *`r euro_table %>% filter(Country == "Albania" & Year == 2016) %>% select(Percentage)`%* in 2016.

# Conclusion 

From our analysis we can see France, Germany, Spain, Norway and Sweden are some of the countries that lead the European production of renewable energy with nuclear being the most prominent renewable energy produced. Across all three years the total renewable energy produced exceeds the total conventional thermal energy produced with 2018 being the highest year. Although this shows positive signs in the movement towards renewable energy, conventional thermal energy still dominates production in many European countries such as Germany and the United Kingdom making just under half the total energy production across Europe across all three years. 

When assessing the exports to imports of energy across Europe we can see France and Germany lead in net exports and are the leading countries in renewable energy production. However, when assessing year over year, 2018 showed a net import of energy compared to the net export of energy in 2016 and 2017. 

The energy type contribution of each country is still dominated by conventional thermal. Some countries like Albania and Denmark supply electricity in their country using renewable energy sources like hydro and wind power respectively. Although several countries have implemented solar power as an energy source, it only provides a small percentage of energy supply.

The pumped hydro power which was earlier included within the hydro power analysis, also showed it's contribution to the energy production. Although it does not produce the high amount of energy as the other energy types, it is still being used and improved for better production. We expected none of the energy types to absorb energy from other energy types for its energy production. However, during our data analysis, we found out that pumped hydro power absorbs energy to produce energy. In fact, pumped hydro power consumes more amount of energy than it produces in 2016 & 2017, but this has improved in countries like Austria and Norway in 2018. However, pumped hydro power is still not producing a high amount of energy that is comparable with other renewable energy sources.

Many countries have in fact surpassed their 2020 target level by 2018. Countries like Iceland, Norway, Sweden, Finland and Denmark are dominating the field and charging ahead of the pack to cement their status as the front runners in sustainability practices. Thus we can conclude that the European continent is adopting more of a renewable energy source as the means to generate, supply and consume its energy. This helps us to answer our original question and we can confidently say Europe is leading towards a more sustainable future as they adopt a renewable energy consumption approach.

# Acknowledgments

@bookdown\
@forcats\
@ggplot2\
@kableExtra\
@knitr\
@lubridate\
@naniar\
@plotly\
@readr\
@readxl\
@scales\
@tidytuesday\
@tidyverse


# References


@energygif
