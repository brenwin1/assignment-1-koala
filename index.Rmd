---
title: "ETC5521 Assignment 1"
subtitle: "How sustainable is the energy production in Europe? "
team: Koala
author:
  - Patu Saputra 
  - Vinny Vu
date: "`r Sys.Date()`"
output: 
  html_document
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(kableExtra)
```

# Introduction and motivation

[FILL] Give the bigger picture of the data, and inspire the reader to learn more about the problem by reading your analysis. 

## Questions of Discussion 

How sustainable is the energy production in Europe? 

* Which countries have the highest production of sustainable energy?
*  What is the trend in energy usage in Europe?  
* What is the trend in sustainable vs unsustainable energy production?



# Data description

```{r, include = FALSE}
energy_types <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-08-04/energy_types.csv')
country_totals <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-08-04/country_totals.csv')

energy_types <- energy_types %>%
  replace_na(list(country_name = "United Kingdom")) %>%
    pivot_longer(cols = starts_with("20"),
               names_to = "year",
               values_to = "energy")
energy_types$year <- as.numeric(energy_types$year)

country_totals <- country_totals %>% 
  replace_na(list(country_name = "United Kingdom")) %>%
  pivot_longer(cols = starts_with("20"),
               names_to = "year",
               values_to = "energy")
country_totals$year <- as.numeric(country_totals$year)
```

The data in the tidytuesday package is taken from Eurostat that contains the electricity production of the countries in the European Union.  The data is given in tabular form in two tables, `country_totals` and `energy_types`. The `energy_types` table containing the types of energy produced by each country. The `country_totals` table contains the brake down energy supplied by each country.
The variables in the `energy_types` table are included below:

```{r,include = FALSE}
variables_1 <- energy_types %>% names()
class_1 <- sapply(energy_types, class)
desc_1 <- c("Country ID",
           "Country name",
           "Type of energy production",
           "Level - either total, level 1 or level 2. Where level 2 makes up level 1 that makes up the total",
           "Year of observation",
           "Energy in GWh (Gigawatt hours)")
```

```{r, echo=FALSE}
tibble(variables_1,class_1,desc_1) %>%
  kable(col.names = c("variable","class","description")) %>%
  kable_styling(bootstrap_options = "hover")
```

The variables in the `country_totals` table are included below: 

```{r, include = FALSE}
variables_2 <- country_totals %>% names()
class_2 <- sapply(country_totals, class)
desc_2 <- c("Country ID",
           "Country name",
           "Type of energy production",
           "Level - either total, level 1 or level 2. Where level 2 makes up level 1 that makes up the total",
           "Year of observation",
           "Energy in GWh (Gigawatt hours)")
```

```{r, echo=FALSE}
tibble(variables_2,class_2,desc_2) %>%
  kable(col.names = c("variable","class","description")) %>%
  kable_styling(bootstrap_options = "hover")
```

The data in the tidytuesday package only contains yearly totals from 2016-2018. However, monthly data can be found on the Eurostat website including data from 2010 until May 2020 as at 14-08-20. The statistics are collected and compiled by Member States. Eurostat prepared a template to gather this information.  


# Analysis and findings


[FILL] Should include at least one plot or numerical summary for each of your questions, that helps the reader arrive at an answer. You should also write paragraphs describing the methods, summaries and findings. 

## Energy types contribution to total energy production for each country in Europe

```{r contribution-tbl-country, include=FALSE, warning=FALSE, message=FALSE}
extract_total_net <- function(x){
total_year <- country_totals %>% 
  filter(type=="Total net production", year==x) %>%
  select(-type,-country) %>%
  pivot_wider(names_from = "level", values_from ="energy")
return(total_year)
}

country_total_2016 <- extract_total_net(2016)
country_total_2017 <- extract_total_net(2017)
country_total_2018 <-extract_total_net(2018)

extract_energy <- function(x){
total_year <- energy_types %>% 
  filter(year==x, level == "Level 1") %>%
  select(-country) %>%
  pivot_wider(names_from = "type", values_from ="energy")
return(total_year)
}

en_types_2016 <- extract_energy(2016)
en_types_2017 <- extract_energy(2017)
en_types_2018 <- extract_energy(2018)

energy_contribution <- function(df1,df2){
df1 %>%
  inner_join(df2, by="country_name") %>%
  select(-year.y) %>%
  rename(year=year.x) %>%
  mutate(thermal = round(`Conventional thermal`/Total*100, digits = 2),
         nuclear = round(Nuclear/Total*100, digits = 2),
         hydro = round(Hydro/Total*100, digits = 2),
         wind = round(Wind/Total*100, digits = 2),
         solar = round(Solar/Total*100, digits = 2),
         geothermal = round(Geothermal/Total*100, digits = 2),
         other = round(Other/Total*100, digits = 2)) %>%
    select(-c(`Conventional thermal`, Nuclear, Hydro, Wind, Solar, Geothermal,Other,Total, level)) 
}

energy_contribution_2016 <- energy_contribution(en_types_2016,country_total_2016)
energy_contribution_2017 <- energy_contribution(en_types_2017,country_total_2017)
energy_contribution_2018 <- energy_contribution(en_types_2018,country_total_2018)
```

```{r tbl-contribution-europe, include=FALSE, warning=FALSE, message=FALSE}
get_total <- function(df1,df2,df3){
  df1 <- df1 %>%
  summarise(year=min(year), Total = sum(Total))
  df2 <- df2 %>%
  summarise(year=min(year), Total = sum(Total))
  df3 <- df3 %>%
  summarise(year=min(year),Total = sum(Total))
 rbind(df1,df2,df3) 
}

europe_total_production <- get_total(country_total_2016,country_total_2017,country_total_2018)

europe_energy_cont <- function(df){
  df %>%
  summarise(year = min(year),
            Geothermal = sum(Geothermal),
            Nuclear = sum(Nuclear),
            Hydro = sum(Hydro),
            Wind = sum(Wind),
            Solar = sum(Solar),
            `Conventional thermal` = sum(`Conventional thermal`),
            Other = sum(Other))
}

europe_total_energy <- rbind(europe_energy_cont(en_types_2016),
                           europe_energy_cont(en_types_2017),
                           europe_energy_cont(en_types_2018))

europe_energy_contribution <- function(df1,df2){
df1 %>%
  left_join(df2, by="year") %>%
  mutate(Thermal = round(`Conventional thermal`/Total*100, digits = 2),
         Nuclear = round(Nuclear/Total*100, digits = 2),
         Hydro = round(Hydro/Total*100, digits = 2),
         Wind = round(Wind/Total*100, digits = 2),
         Solar = round(Solar/Total*100, digits = 2),
         Geothermal = round(Geothermal/Total*100, digits = 2),
         Other = round(Other/Total*100, digits = 2)) %>%
    select(-c(`Conventional thermal`, Total)) 
}

contribute_to_europe <- europe_energy_contribution(europe_total_energy,
                                                   europe_total_production)
```

```{r piechart-europe, echo=FALSE, warning=FALSE, message=FALSE}
library(plotly)
p <- contribute_to_europe %>%
    pivot_longer(cols=c(2:8),
                 names_to = "contribution",
                 values_to = "value")

 a <- p %>%
   mutate(contribution_fct = fct_reorder(contribution,value)) %>%
  ggplot(aes(x=contribution_fct,
         y=value,
         fill=contribution)) +
  geom_bar(stat="identity",
           position = "dodge") +
   geom_text(aes(label=value), position = "stack", hjust=-0.5, size=2.5) +
   facet_wrap(~year) +
  ggtitle("Energy source contribution to the total production in Europe")+
    ylab("percentage") +
    xlab("") +
   scale_y_continuous(limits = c(0,100))+
   coord_flip()+
   theme_minimal() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6),
        axis.text.y = element_text(size=7), 
        axis.title.y = element_text(size=6),
        axis.title.x = element_text(size=6),
        plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9, face = "bold"))
 
 a
```

```{r plot-contribution-country, echo=FALSE, warning=FALSE, message=FALSE}
create_plot <- function(df){
year <- paste0(df$year[1])
df_tbl <-  df %>%
    pivot_longer(cols=c(3:9),
                 names_to = "contribution",
                 values_to = "value") 
df_tbl$contribution = factor(df_tbl$contribution, levels=c('hydro','wind','solar','nuclear','thermal','geothermal','other'))
  
df_tbl %>%
  mutate(country_fct = fct_reorder(country_name, value)) %>%
  ggplot(aes(x=country_fct, y= value, fill= contribution)) +
  geom_col(position = "stack") +
  theme_minimal() +
  facet_wrap(contribution ~., ncol=7) +
  coord_flip() +
  ggtitle("Energy source contribution to the total production in %",year)+
    ylab("percentage") +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6),
        axis.text.y = element_text(size=7),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=6),
        plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9, face = "bold"))
}

create_plot(energy_contribution_2016)
create_plot(energy_contribution_2017)
create_plot(energy_contribution_2018)
```


# References

